
<div class="card">
    <div class="card-body">
        <h5 class="card-title">AFLIE Speech Engine</h5>
        <p class="card-text">
            Start and monitor the speech engine and module from the
        </p>

        <div class="row">

            <!-- Transcription and response -->
            <div class="col-sm-8" id="assistant_window" >
                <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">AI Assistance</h5>
                      <h6 class="card-subtitle mb-2 text-body-secondary">Model: Palm2 (Google)</h6>
                      <p class="card-text">

                        <br>
                        <span id="ai_response" class="text-body-secondary>">
                            <!-- nothing yet! -->
                        </span>
                        <br>

                        <!-- simple input with id 'system_prompt' -->
                        <label for="exampleFormControlTextarea1">System Input</label>
                        <input type="text" id="system_prompt" class="form-control" placeholder="Enter your response here" aria-label="Enter your response here" aria-describedby="button-addon2">

                        <br>
                        <label for="previous_message" class="" >Previous input</label><br>
                        <span id="previous_msg">

                        </span>
                      </p>
                      <!-- <a href="#" class="card-link">Card link</a>
                      <a href="#" class="card-link">Regenerate Response</a> -->
                    </div>
                  </div>
            </div>

            <!-- Requesting a transcription -->
            <div class="col-sm-4 mt-5">
                <div class="form-group">
                    <label for="exampleFormControlTextarea1">Transcription</label>
                    <textarea readonly placeholder="Whisper Transcription" class="form-control" id="exampleFormControlTextarea1" rows="8"></textarea>
                </div>
            </div>

        </div>
        

        
    </div>
    <button id="record-btn" class="btn btn-primary btn-sm">Start Recording</button>
    <button id="stop-btn" class="btn btn-danger btn-sm" disabled>Stop Recording</button>
    <audio id="audio-player"></audio>
</div>

<script>
    const recordBtn = document.getElementById("record-btn");
    const stopBtn = document.getElementById("stop-btn");
    const systemInput = document.getElementById("system_prompt");

    // add event listener to the system input
    systemInput.addEventListener("keyup", async function(event){
        // console.log(event.key);
        if(event.key === 'Enter'){
            const formData = new FormData();
            formData.append("system_prompt", systemInput.value);

            console.log(formData);

            // call the api and pass the form data.
            fetch('/text_input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({system_prompt: systemInput.value}), // replace with your audio data
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // set the value of the previous message
                const previousMsgElement = document.getElementById("previous_msg");
                previousMsgElement.innerHTML = systemInput.value;

                // clear the system input
                systemInput.value = '';

                return response.json(); // assuming the server responds with JSON
            })
            .then(result => {
                console.log(result);
            })
            .catch(e => {
                console.log('There was a problem with your fetch operation: ' + e.message);
            });
        }        

    });


    // const playBtn = document.getElementById("play-btn");
    const audioPlayer = document.getElementById("audio-player");
    let recorder, audioChunks;

    recordBtn.addEventListener("click", async () => {
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.start();
            })
            .catch(err => console.error(err));
    });

    stopBtn.addEventListener("click", () => {
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        // playBtn.disabled = false;

        recorder.stop();
        recorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const formData = new FormData();
            formData.append("audio", audioBlob, "audio.webm");

            fetch('/audio', {
                method: 'POST',
                body: formData, // replace with your audio data
            })
            .then(response => response.json()) // assuming the server responds with JSON
            .then(result => {
                console.log(result);
                if (result.message === 'Audio recording saved successfully!') {
                    // Access the transcription from the result
                    const transcription = result.transcription;
                    console.log(transcription);

                    
                    // Trigger your action here with the ai_response
                    const aiResponseElement = document.getElementById("ai_response");
                    aiResponseElement.innerHTML = result.ai_response;
                    aiResponseElement.classList.remove("d-none");

                    // set the trsncription to the textarea
                    document.getElementById("exampleFormControlTextarea1").innerHTML = transcription;
                }
            })
            .catch(error => console.error('Error:', error));
        };
    });
</script>